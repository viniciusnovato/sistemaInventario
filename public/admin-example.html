<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - Sistema de Inventário</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-boxes me-2"></i>Sistema de Inventário
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    <i class="fas fa-user me-1"></i>
                    <span data-user-email>Carregando...</span>
                </span>
                <button class="btn btn-outline-light btn-sm" data-logout-btn>
                    <i class="fas fa-sign-out-alt me-1"></i>Sair
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1><i class="fas fa-shield-alt me-2"></i>Painel Administrativo</h1>
                    <div class="badge bg-success fs-6" id="adminBadge" style="display: none;">
                        <i class="fas fa-crown me-1"></i>Administrador
                    </div>
                </div>

                <!-- Seção de Status de Permissões -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-key me-2"></i>Status de Permissões</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Verificações de Role:</h6>
                                <ul class="list-group list-group-flush" id="roleChecks">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>É Admin?</span>
                                        <span class="badge" id="isAdminBadge">Verificando...</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>É Usuário?</span>
                                        <span class="badge" id="isUserBadge">Verificando...</span>
                                    </li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Verificações de Permissões:</h6>
                                <ul class="list-group list-group-flush" id="permissionChecks">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>Acesso Total (admin.all)</span>
                                        <span class="badge" id="adminAllBadge">Verificando...</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>Gerenciar Usuários (users.manage)</span>
                                        <span class="badge" id="usersManageBadge">Verificando...</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>Ler Inventário (inventory.read)</span>
                                        <span class="badge" id="inventoryReadBadge">Verificando...</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Seção de Permissões do Usuário -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-list me-2"></i>Todas as Permissões do Usuário</h5>
                    </div>
                    <div class="card-body">
                        <div id="userPermissions">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Carregando permissões...</span>
                                </div>
                                <p class="mt-2">Carregando permissões...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Seção de Ações Administrativas -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Ações Administrativas</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <div class="card border-primary">
                                    <div class="card-body text-center">
                                        <i class="fas fa-users fa-2x text-primary mb-2"></i>
                                        <h6>Gerenciar Usuários</h6>
                                        <button class="btn btn-primary btn-sm" onclick="testPermissionAction('users.manage')">
                                            Testar Acesso
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card border-success">
                                    <div class="card-body text-center">
                                        <i class="fas fa-boxes fa-2x text-success mb-2"></i>
                                        <h6>Gerenciar Inventário</h6>
                                        <button class="btn btn-success btn-sm" onclick="testPermissionAction('inventory.write')">
                                            Testar Acesso
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card border-danger">
                                    <div class="card-body text-center">
                                        <i class="fas fa-shield-alt fa-2x text-danger mb-2"></i>
                                        <h6>Configurações Admin</h6>
                                        <button class="btn btn-danger btn-sm" onclick="testPermissionAction('admin.all')">
                                            Testar Acesso
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Resultado -->
    <div class="modal fade" id="resultModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Resultado do Teste</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Conteúdo será inserido dinamicamente -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script>
        // Aguardar inicialização do auth
        document.addEventListener('DOMContentLoaded', async () => {
            // Aguardar um pouco para o authManager inicializar
            setTimeout(async () => {
                await loadPermissionStatus();
                await loadUserPermissions();
            }, 500);
        });

        async function loadPermissionStatus() {
            try {
                // Verificar roles
                const isAdmin = await authManager.isAdmin();
                const isUser = await authManager.hasRole('user');

                document.getElementById('isAdminBadge').textContent = isAdmin ? 'Sim' : 'Não';
                document.getElementById('isAdminBadge').className = `badge ${isAdmin ? 'bg-success' : 'bg-secondary'}`;

                document.getElementById('isUserBadge').textContent = isUser ? 'Sim' : 'Não';
                document.getElementById('isUserBadge').className = `badge ${isUser ? 'bg-success' : 'bg-secondary'}`;

                // Mostrar badge de admin se for admin
                if (isAdmin) {
                    document.getElementById('adminBadge').style.display = 'block';
                }

                // Verificar permissões específicas
                const hasAdminAll = await authManager.hasPermission('admin.all');
                const hasUsersManage = await authManager.hasPermission('users.manage');
                const hasInventoryRead = await authManager.hasPermission('inventory.read');

                document.getElementById('adminAllBadge').textContent = hasAdminAll ? 'Permitido' : 'Negado';
                document.getElementById('adminAllBadge').className = `badge ${hasAdminAll ? 'bg-success' : 'bg-danger'}`;

                document.getElementById('usersManageBadge').textContent = hasUsersManage ? 'Permitido' : 'Negado';
                document.getElementById('usersManageBadge').className = `badge ${hasUsersManage ? 'bg-success' : 'bg-danger'}`;

                document.getElementById('inventoryReadBadge').textContent = hasInventoryRead ? 'Permitido' : 'Negado';
                document.getElementById('inventoryReadBadge').className = `badge ${hasInventoryRead ? 'bg-success' : 'bg-danger'}`;

            } catch (error) {
                console.error('Erro ao carregar status de permissões:', error);
            }
        }

        async function loadUserPermissions() {
            try {
                const permissions = await authManager.getUserPermissions();
                const container = document.getElementById('userPermissions');

                if (permissions.length === 0) {
                    container.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Nenhuma permissão encontrada para este usuário.
                        </div>
                    `;
                    return;
                }

                let html = '<div class="row">';
                permissions.forEach((permission, index) => {
                    html += `
                        <div class="col-md-6 mb-3">
                            <div class="card border-info">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-key me-2"></i>${permission.name}
                                    </h6>
                                    <p class="card-text small mb-2">${permission.description || 'Sem descrição'}</p>
                                    <div class="d-flex justify-content-between">
                                        <span class="badge bg-primary">${permission.resource}</span>
                                        <span class="badge bg-secondary">${permission.action}</span>
                                        <span class="badge bg-info">${permission.role}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';

                container.innerHTML = html;

            } catch (error) {
                console.error('Erro ao carregar permissões do usuário:', error);
                document.getElementById('userPermissions').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Erro ao carregar permissões: ${error.message}
                    </div>
                `;
            }
        }

        async function testPermissionAction(permissionName) {
            try {
                const hasPermission = await authManager.hasPermission(permissionName);
                
                const modalBody = document.getElementById('modalBody');
                const modal = new bootstrap.Modal(document.getElementById('resultModal'));

                if (hasPermission) {
                    modalBody.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Acesso Permitido!</strong><br>
                            Você tem a permissão <code>${permissionName}</code> e pode acessar esta funcionalidade.
                        </div>
                    `;
                } else {
                    modalBody.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-times-circle me-2"></i>
                            <strong>Acesso Negado!</strong><br>
                            Você não tem a permissão <code>${permissionName}</code> necessária para acessar esta funcionalidade.
                        </div>
                    `;
                }

                modal.show();

            } catch (error) {
                console.error('Erro ao testar permissão:', error);
                
                const modalBody = document.getElementById('modalBody');
                const modal = new bootstrap.Modal(document.getElementById('resultModal'));

                modalBody.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Erro no Teste!</strong><br>
                        Ocorreu um erro ao verificar a permissão: ${error.message}
                    </div>
                `;

                modal.show();
            }
        }
    </script>
</body>
</html>