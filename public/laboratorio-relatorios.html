<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rios Laborat√≥rio - Sistema de Invent√°rio</title>
    <link rel="stylesheet" href="prostoral.css">
    <style>
        .lab-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .lab-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .lab-header h1 {
            margin: 0;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .lab-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #2ecc71;
            color: white;
        }

        .btn-success:hover {
            background: #27ae60;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .report-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .report-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .report-card h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .report-card p {
            margin: 0 0 15px 0;
            color: #7f8c8d;
            font-size: 14px;
        }

        .report-filters {
            display: grid;
            gap: 10px;
            margin-bottom: 15px;
        }

        .report-filters input,
        .report-filters select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .results-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 20px;
            margin-top: 30px;
            display: none;
        }

        .results-container.active {
            display: block;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .results-header h2 {
            margin: 0;
            color: #2c3e50;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
        }

        .results-table thead {
            background: #34495e;
            color: white;
        }

        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        .results-table tbody tr:hover {
            background: #f8f9fa;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-card {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }

        .summary-card.success {
            border-left-color: #2ecc71;
        }

        .summary-card.warning {
            border-left-color: #f39c12;
        }

        .summary-card.danger {
            border-left-color: #e74c3c;
        }

        .summary-card h4 {
            margin: 0 0 8px 0;
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
        }

        .summary-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .chart-container {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        @media (max-width: 768px) {
            .lab-header {
                flex-direction: column;
                align-items: stretch;
            }

            .reports-grid {
                grid-template-columns: 1fr;
            }

            .results-header {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .results-table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <div class="lab-container">
        <!-- Header -->
        <div class="lab-header">
            <h1>üìä Relat√≥rios do Laborat√≥rio</h1>
            <div class="lab-actions">
                <button class="btn btn-primary" onclick="location.href='laboratorio-produtos.html'">
                    üß™ Produtos
                </button>
                <button class="btn btn-primary" onclick="location.href='laboratorio-movimentacoes.html'">
                    üì¶ Movimenta√ß√µes
                </button>
                <button class="btn btn-warning" onclick="location.href='laboratorio-alertas.html'">
                    üîî Alertas
                </button>
            </div>
        </div>

        <!-- Reports Grid -->
        <div class="reports-grid">
            <!-- Valor do Estoque -->
            <div class="report-card">
                <h3>üí∞ Valor do Estoque</h3>
                <p>Calcule o valor total do estoque baseado no pre√ßo m√©dio de compra</p>
                <button class="btn btn-primary" onclick="gerarRelatorioValorEstoque()" style="width: 100%;">
                    Gerar Relat√≥rio
                </button>
            </div>

            <!-- Movimenta√ß√µes por Per√≠odo -->
            <div class="report-card">
                <h3>üìÖ Movimenta√ß√µes por Per√≠odo</h3>
                <p>Visualize todas as movimenta√ß√µes em um per√≠odo espec√≠fico</p>
                <div class="report-filters">
                    <input type="date" id="mov-data-inicio" placeholder="Data In√≠cio">
                    <input type="date" id="mov-data-fim" placeholder="Data Fim">
                </div>
                <button class="btn btn-primary" onclick="gerarRelatorioMovimentacoes()" style="width: 100%;">
                    Gerar Relat√≥rio
                </button>
            </div>

            <!-- Consumo por Respons√°vel -->
            <div class="report-card">
                <h3>üë§ Consumo por Respons√°vel</h3>
                <p>An√°lise de consumo agrupado por respons√°vel</p>
                <div class="report-filters">
                    <input type="date" id="resp-data-inicio" placeholder="Data In√≠cio">
                    <input type="date" id="resp-data-fim" placeholder="Data Fim">
                </div>
                <button class="btn btn-primary" onclick="gerarRelatorioResponsavel()" style="width: 100%;">
                    Gerar Relat√≥rio
                </button>
            </div>

            <!-- Consumo por Caso Cl√≠nico -->
            <div class="report-card">
                <h3>üè• Consumo por Caso Cl√≠nico</h3>
                <p>Rastreabilidade de materiais utilizados por caso</p>
                <div class="report-filters">
                    <input type="text" id="caso-clinico" placeholder="N√∫mero do Caso (opcional)">
                    <input type="date" id="caso-data-inicio" placeholder="Data In√≠cio">
                    <input type="date" id="caso-data-fim" placeholder="Data Fim">
                </div>
                <button class="btn btn-primary" onclick="gerarRelatorioCasoClin ico()" style="width: 100%;">
                    Gerar Relat√≥rio
                </button>
            </div>

            <!-- Produtos Mais Utilizados -->
            <div class="report-card">
                <h3>üîù Produtos Mais Utilizados</h3>
                <p>Ranking de produtos mais consumidos</p>
                <div class="report-filters">
                    <input type="date" id="top-data-inicio" placeholder="Data In√≠cio">
                    <input type="date" id="top-data-fim" placeholder="Data Fim">
                    <input type="number" id="top-limit" placeholder="Quantidade (padr√£o: 10)" value="10" min="1" max="50">
                </div>
                <button class="btn btn-primary" onclick="gerarRelatorioTopProdutos()" style="width: 100%;">
                    Gerar Relat√≥rio
                </button>
            </div>

            <!-- Hist√≥rico de Compras -->
            <div class="report-card">
                <h3>üõí Hist√≥rico de Compras</h3>
                <p>Relat√≥rio detalhado de compras e custos</p>
                <div class="report-filters">
                    <input type="date" id="compra-data-inicio" placeholder="Data In√≠cio">
                    <input type="date" id="compra-data-fim" placeholder="Data Fim">
                    <select id="compra-fornecedor">
                        <option value="">Todos os Fornecedores</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="gerarRelatorioCompras()" style="width: 100%;">
                    Gerar Relat√≥rio
                </button>
            </div>
        </div>

        <!-- Results Container -->
        <div class="results-container" id="results-container">
            <div class="results-header">
                <h2 id="results-title">Resultados</h2>
                <div>
                    <button class="btn btn-success" onclick="exportarExcel()">
                        üì• Exportar Excel
                    </button>
                    <button class="btn btn-secondary" onclick="imprimirRelatorio()">
                        üñ®Ô∏è Imprimir
                    </button>
                    <button class="btn btn-secondary" onclick="fecharResultados()">
                        ‚úï Fechar
                    </button>
                </div>
            </div>

            <div id="results-summary"></div>
            <div id="results-content"></div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script>
        let currentReportData = null;
        let currentReportType = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadFornecedores();
            setDefaultDates();
        });

        // Check authentication
        async function checkAuth() {
            const session = getSession();
            if (!session) {
                window.location.href = 'login.html';
                return;
            }
        }

        // Set default dates (last 30 days)
        function setDefaultDates() {
            const hoje = new Date();
            const trintaDiasAtras = new Date();
            trintaDiasAtras.setDate(hoje.getDate() - 30);
            
            const hojeStr = hoje.toISOString().split('T')[0];
            const trintaDiasStr = trintaDiasAtras.toISOString().split('T')[0];
            
            document.querySelectorAll('input[type="date"]').forEach(input => {
                if (input.placeholder === 'Data In√≠cio') {
                    input.value = trintaDiasStr;
                } else if (input.placeholder === 'Data Fim') {
                    input.value = hojeStr;
                }
            });
        }

        // Load fornecedores
        async function loadFornecedores() {
            try {
                const response = await fetch(`${API_URL}/laboratorio/fornecedores`, {
                    headers: {
                        'Authorization': `Bearer ${getSession().access_token}`
                    }
                });
                
                if (response.ok) {
                    const fornecedores = await response.json();
                    const select = document.getElementById('compra-fornecedor');
                    fornecedores.forEach(f => {
                        const option = document.createElement('option');
                        option.value = f.fornecedor;
                        option.textContent = f.fornecedor;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar fornecedores:', error);
            }
        }

        // Gerar Relat√≥rio: Valor do Estoque
        async function gerarRelatorioValorEstoque() {
            try {
                showLoading();
                
                const response = await fetch(`${API_URL}/laboratorio/relatorios/valor-estoque`, {
                    headers: {
                        'Authorization': `Bearer ${getSession().access_token}`
                    }
                });
                
                if (!response.ok) throw new Error('Erro ao gerar relat√≥rio');
                
                const data = await response.json();
                currentReportData = data;
                currentReportType = 'valor-estoque';
                
                document.getElementById('results-title').textContent = 'üí∞ Valor do Estoque';
                
                // Summary
                const summary = `
                    <div class="summary-grid">
                        <div class="summary-card success">
                            <h4>Valor Total</h4>
                            <div class="value">‚Ç¨ ${formatNumber(data.valor_total || 0)}</div>
                        </div>
                        <div class="summary-card">
                            <h4>Produtos</h4>
                            <div class="value">${data.produtos.length}</div>
                        </div>
                    </div>
                `;
                
                // Table
                const table = `
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Produto</th>
                                <th>Categoria</th>
                                <th>Quantidade</th>
                                <th>Pre√ßo M√©dio</th>
                                <th>Valor Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.produtos.map(p => `
                                <tr>
                                    <td>${escapeHtml(p.nome_material)}</td>
                                    <td>${p.categoria}</td>
                                    <td>${formatNumber(p.quantidade_atual)} ${p.unidade_medida}</td>
                                    <td>‚Ç¨ ${formatNumber(p.preco_unitario_medio || 0)}</td>
                                    <td><strong>‚Ç¨ ${formatNumber(p.valor_total || 0)}</strong></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                document.getElementById('results-summary').innerHTML = summary;
                document.getElementById('results-content').innerHTML = table;
                showResults();
                
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao gerar relat√≥rio. Tente novamente.');
            }
        }

        // Gerar Relat√≥rio: Movimenta√ß√µes
        async function gerarRelatorioMovimentacoes() {
            try {
                const dataInicio = document.getElementById('mov-data-inicio').value;
                const dataFim = document.getElementById('mov-data-fim').value;
                
                if (!dataInicio || !dataFim) {
                    alert('Por favor, selecione o per√≠odo.');
                    return;
                }
                
                showLoading();
                
                const response = await fetch(
                    `${API_URL}/laboratorio/relatorios/movimentacoes?dataInicio=${dataInicio}&dataFim=${dataFim}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${getSession().access_token}`
                        }
                    }
                );
                
                if (!response.ok) throw new Error('Erro ao gerar relat√≥rio');
                
                const data = await response.json();
                currentReportData = data;
                currentReportType = 'movimentacoes';
                
                document.getElementById('results-title').textContent = 'üìÖ Movimenta√ß√µes por Per√≠odo';
                
                // Summary
                const summary = `
                    <div class="summary-grid">
                        <div class="summary-card success">
                            <h4>Entradas</h4>
                            <div class="value">${data.total_entradas || 0}</div>
                        </div>
                        <div class="summary-card danger">
                            <h4>Sa√≠das</h4>
                            <div class="value">${data.total_saidas || 0}</div>
                        </div>
                        <div class="summary-card">
                            <h4>Total</h4>
                            <div class="value">${data.movimentacoes.length}</div>
                        </div>
                    </div>
                `;
                
                // Table
                const table = `
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Tipo</th>
                                <th>Produto</th>
                                <th>Quantidade</th>
                                <th>Respons√°vel</th>
                                <th>Caso Cl√≠nico</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.movimentacoes.map(m => `
                                <tr>
                                    <td>${formatDateTime(m.data_movimento)}</td>
                                    <td>${m.tipo_movimento}</td>
                                    <td>${escapeHtml(m.produto_nome)}</td>
                                    <td>${formatNumber(m.quantidade)} ${m.unidade_medida}</td>
                                    <td>${escapeHtml(m.responsavel_nome)}</td>
                                    <td>${m.caso_clinico || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                document.getElementById('results-summary').innerHTML = summary;
                document.getElementById('results-content').innerHTML = table;
                showResults();
                
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao gerar relat√≥rio. Tente novamente.');
            }
        }

        // Gerar Relat√≥rio: Consumo por Respons√°vel
        async function gerarRelatorioResponsavel() {
            try {
                const dataInicio = document.getElementById('resp-data-inicio').value;
                const dataFim = document.getElementById('resp-data-fim').value;
                
                if (!dataInicio || !dataFim) {
                    alert('Por favor, selecione o per√≠odo.');
                    return;
                }
                
                showLoading();
                
                const response = await fetch(
                    `${API_URL}/laboratorio/relatorios/consumo-responsavel?dataInicio=${dataInicio}&dataFim=${dataFim}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${getSession().access_token}`
                        }
                    }
                );
                
                if (!response.ok) throw new Error('Erro ao gerar relat√≥rio');
                
                const data = await response.json();
                currentReportData = data;
                currentReportType = 'responsavel';
                
                document.getElementById('results-title').textContent = 'üë§ Consumo por Respons√°vel';
                
                // Table
                const table = `
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Respons√°vel</th>
                                <th>Total de Movimenta√ß√µes</th>
                                <th>Entradas</th>
                                <th>Sa√≠das</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(r => `
                                <tr>
                                    <td><strong>${escapeHtml(r.responsavel_nome)}</strong></td>
                                    <td>${r.total_movimentacoes}</td>
                                    <td>${r.total_entradas}</td>
                                    <td>${r.total_saidas}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                document.getElementById('results-summary').innerHTML = '';
                document.getElementById('results-content').innerHTML = table;
                showResults();
                
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao gerar relat√≥rio. Tente novamente.');
            }
        }

        // Gerar Relat√≥rio: Caso Cl√≠nico
        async function gerarRelatorioCasoClinico() {
            try {
                const casoClinco = document.getElementById('caso-clinico').value;
                const dataInicio = document.getElementById('caso-data-inicio').value;
                const dataFim = document.getElementById('caso-data-fim').value;
                
                if (!dataInicio || !dataFim) {
                    alert('Por favor, selecione o per√≠odo.');
                    return;
                }
                
                showLoading();
                
                let url = `${API_URL}/laboratorio/relatorios/consumo-caso?dataInicio=${dataInicio}&dataFim=${dataFim}`;
                if (casoClinco) url += `&caso=${encodeURIComponent(casoClinco)}`;
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${getSession().access_token}`
                    }
                });
                
                if (!response.ok) throw new Error('Erro ao gerar relat√≥rio');
                
                const data = await response.json();
                currentReportData = data;
                currentReportType = 'caso-clinico';
                
                document.getElementById('results-title').textContent = 'üè• Consumo por Caso Cl√≠nico';
                
                // Table
                const table = `
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Caso Cl√≠nico</th>
                                <th>Produto</th>
                                <th>Quantidade</th>
                                <th>Data</th>
                                <th>Respons√°vel</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(c => `
                                <tr>
                                    <td><strong>${c.caso_clinico || '-'}</strong></td>
                                    <td>${escapeHtml(c.produto_nome)}</td>
                                    <td>${formatNumber(c.quantidade)} ${c.unidade_medida}</td>
                                    <td>${formatDateTime(c.data_movimento)}</td>
                                    <td>${escapeHtml(c.responsavel_nome)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                document.getElementById('results-summary').innerHTML = '';
                document.getElementById('results-content').innerHTML = table;
                showResults();
                
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao gerar relat√≥rio. Tente novamente.');
            }
        }

        // Gerar Relat√≥rio: Top Produtos
        async function gerarRelatorioTopProdutos() {
            try {
                const dataInicio = document.getElementById('top-data-inicio').value;
                const dataFim = document.getElementById('top-data-fim').value;
                const limit = document.getElementById('top-limit').value || 10;
                
                if (!dataInicio || !dataFim) {
                    alert('Por favor, selecione o per√≠odo.');
                    return;
                }
                
                showLoading();
                
                const response = await fetch(
                    `${API_URL}/laboratorio/relatorios/top-produtos?dataInicio=${dataInicio}&dataFim=${dataFim}&limit=${limit}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${getSession().access_token}`
                        }
                    }
                );
                
                if (!response.ok) throw new Error('Erro ao gerar relat√≥rio');
                
                const data = await response.json();
                currentReportData = data;
                currentReportType = 'top-produtos';
                
                document.getElementById('results-title').textContent = 'üîù Produtos Mais Utilizados';
                
                // Table
                const table = `
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Posi√ß√£o</th>
                                <th>Produto</th>
                                <th>Categoria</th>
                                <th>Quantidade Consumida</th>
                                <th>N√∫mero de Movimenta√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map((p, idx) => `
                                <tr>
                                    <td><strong>${idx + 1}¬∫</strong></td>
                                    <td>${escapeHtml(p.produto_nome)}</td>
                                    <td>${p.categoria}</td>
                                    <td>${formatNumber(p.quantidade_total)} ${p.unidade_medida}</td>
                                    <td>${p.numero_movimentacoes}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                document.getElementById('results-summary').innerHTML = '';
                document.getElementById('results-content').innerHTML = table;
                showResults();
                
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao gerar relat√≥rio. Tente novamente.');
            }
        }

        // Gerar Relat√≥rio: Compras
        async function gerarRelatorioCompras() {
            try {
                const dataInicio = document.getElementById('compra-data-inicio').value;
                const dataFim = document.getElementById('compra-data-fim').value;
                const fornecedor = document.getElementById('compra-fornecedor').value;
                
                if (!dataInicio || !dataFim) {
                    alert('Por favor, selecione o per√≠odo.');
                    return;
                }
                
                showLoading();
                
                let url = `${API_URL}/laboratorio/relatorios/compras?dataInicio=${dataInicio}&dataFim=${dataFim}`;
                if (fornecedor) url += `&fornecedor=${encodeURIComponent(fornecedor)}`;
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${getSession().access_token}`
                    }
                });
                
                if (!response.ok) throw new Error('Erro ao gerar relat√≥rio');
                
                const data = await response.json();
                currentReportData = data;
                currentReportType = 'compras';
                
                document.getElementById('results-title').textContent = 'üõí Hist√≥rico de Compras';
                
                // Summary
                const valorTotal = data.compras.reduce((sum, c) => sum + (parseFloat(c.preco_total) || 0), 0);
                const summary = `
                    <div class="summary-grid">
                        <div class="summary-card success">
                            <h4>Valor Total</h4>
                            <div class="value">‚Ç¨ ${formatNumber(valorTotal)}</div>
                        </div>
                        <div class="summary-card">
                            <h4>Compras</h4>
                            <div class="value">${data.compras.length}</div>
                        </div>
                    </div>
                `;
                
                // Table
                const table = `
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Produto</th>
                                <th>Fornecedor</th>
                                <th>Quantidade</th>
                                <th>Pre√ßo Unit√°rio</th>
                                <th>Pre√ßo Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.compras.map(c => `
                                <tr>
                                    <td>${formatDate(c.data_compra)}</td>
                                    <td>${escapeHtml(c.produto_nome)}</td>
                                    <td>${escapeHtml(c.fornecedor)}</td>
                                    <td>${formatNumber(c.quantidade_comprada)} ${c.unidade_medida}</td>
                                    <td>‚Ç¨ ${formatNumber(c.preco_unitario)}</td>
                                    <td><strong>‚Ç¨ ${formatNumber(c.preco_total)}</strong></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                document.getElementById('results-summary').innerHTML = summary;
                document.getElementById('results-content').innerHTML = table;
                showResults();
                
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao gerar relat√≥rio. Tente novamente.');
            }
        }

        // Show/Hide results
        function showResults() {
            document.getElementById('results-container').classList.add('active');
            document.getElementById('results-container').scrollIntoView({ behavior: 'smooth' });
        }

        function showLoading() {
            document.getElementById('results-title').textContent = 'Gerando Relat√≥rio...';
            document.getElementById('results-summary').innerHTML = '';
            document.getElementById('results-content').innerHTML = '<div class="loading">Gerando relat√≥rio...</div>';
            showResults();
        }

        function fecharResultados() {
            document.getElementById('results-container').classList.remove('active');
        }

        // Export functions
        function exportarExcel() {
            alert('Fun√ß√£o de exporta√ß√£o para Excel em desenvolvimento.\nEm breve dispon√≠vel!');
        }

        function imprimirRelatorio() {
            window.print();
        }

        // Utility functions
        function formatNumber(number) {
            return new Intl.NumberFormat('pt-PT', { minimumFractionDigits: 0, maximumFractionDigits: 2 }).format(number);
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-PT');
        }

        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return '-';
            const date = new Date(dateTimeString);
            return date.toLocaleString('pt-PT');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>

