<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sele√ß√£o de M√≥dulos - Sistema AreLuna</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a'
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.6s ease-out',
                        'bounce-in': 'bounceIn 0.8s ease-out',
                        'pulse-slow': 'pulse 3s infinite',
                        'float': 'float 6s ease-in-out infinite'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        bounceIn: {
                            '0%': { transform: 'scale(0.3)', opacity: '0' },
                            '50%': { transform: 'scale(1.05)' },
                            '70%': { transform: 'scale(0.9)' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-20px)' }
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Scripts do Sistema -->
    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script src="modules.js"></script>
    
    <!-- Custom Styles -->
    <style>
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .dark .glass-effect {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .dark .gradient-bg {
            background: linear-gradient(135deg, #2D3748 0%, #1A202C 100%);
        }
        
        .module-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .module-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .floating-shapes {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
        }
        
        .floating-shapes::before,
        .floating-shapes::after {
            content: '';
            position: absolute;
            width: 200px;
            height: 200px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: float 8s ease-in-out infinite;
        }
        
        .floating-shapes::before {
            top: 10%;
            left: 10%;
            animation-delay: 0s;
        }
        
        .floating-shapes::after {
            bottom: 10%;
            right: 10%;
            animation-delay: 4s;
        }
    </style>
</head>
<body class="min-h-screen gradient-bg">
    <!-- Floating Background Shapes -->
    <div class="floating-shapes"></div>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="glass-effect rounded-2xl p-8 text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"></div>
            <p class="text-white text-lg">Carregando m√≥dulos...</p>
        </div>
    </div>
    
    <!-- Header -->
    <header class="relative z-10 p-6">
        <div class="max-w-6xl mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center glass-effect">
                    <i class="fas fa-cubes text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-white text-xl font-bold">Sistema AreLuna</h1>
                    <p class="text-white/80 text-sm">Selecione um m√≥dulo para continuar</p>
                </div>
            </div>
            
            <div class="flex items-center space-x-4">
                <div class="text-right">
                    <p class="text-white text-sm" id="userEmail">Carregando...</p>
                    <p class="text-white/80 text-xs">Usu√°rio logado</p>
                </div>
                <button id="logoutBtn" class="glass-effect text-white px-4 py-2 rounded-lg hover:bg-white/20 transition-colors">
                    <i class="fas fa-sign-out-alt mr-2"></i>
                    Sair
                </button>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="relative z-10 px-6 pb-12">
        <div class="max-w-6xl mx-auto">
            <!-- Welcome Section -->
            <div class="text-center mb-12 animate-bounce-in">
                <h2 class="text-4xl md:text-5xl font-bold text-white mb-4">
                    Bem-vindo ao Sistema AreLuna
                </h2>
                <p class="text-xl text-white/90 mb-2">
                    Escolha o m√≥dulo que deseja acessar
                </p>
                <p class="text-white/70">
                    Os m√≥dulos dispon√≠veis s√£o baseados nas suas permiss√µes
                </p>
            </div>
            
            <!-- Bot√£o para voltar ao m√≥dulo selecionado (se houver) -->
            <div class="text-center mb-6" id="back-to-module" style="display: none;">
                <button onclick="window.location.href='index.html'" 
                        class="inline-flex items-center gap-2 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                    <i class="fas fa-arrow-left"></i>
                    Voltar ao Dashboard
                </button>
            </div>
            
            <!-- Modules Grid -->
            <div id="modulesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 animate-slide-up">
                <!-- Modules will be loaded here -->
            </div>
            
            <!-- No Modules Message -->
            <div id="noModulesMessage" class="hidden text-center animate-fade-in">
                <div class="glass-effect rounded-3xl p-12 max-w-md mx-auto">
                    <i class="fas fa-lock text-6xl text-white/60 mb-6"></i>
                    <h3 class="text-2xl font-bold text-white mb-4">Nenhum M√≥dulo Dispon√≠vel</h3>
                    <p class="text-white/80 mb-6">
                        Voc√™ n√£o tem permiss√£o para acessar nenhum m√≥dulo no momento.
                    </p>
                    <p class="text-white/60 text-sm">
                        Entre em contato com o administrador do sistema para solicitar acesso.
                    </p>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script>
        class ModuleSelector {
            constructor() {
                this.authManager = null;
                this.userPermissions = [];
                this.userRoles = [];
                this.availableModules = [
                    {
                        id: 'inventory',
                        name: 'Invent√°rio',
                        description: 'Gest√£o completa do invent√°rio patrimonial',
                        icon: 'fas fa-warehouse',
                        emoji: 'üì¶',
                        color: 'from-blue-500 to-blue-600',
                        hoverColor: 'from-blue-600 to-blue-700',
                        url: 'index.html',
                        requiredPermissions: ['inventory.view', 'view']
                    }
                ];
                
                this.init();
            }
            
            async init() {
                try {
                    // Aguardar o authManager ser inicializado se n√£o estiver dispon√≠vel
                    if (!window.authManager) {
                        // Aguardar um pouco para o authManager ser carregado
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        if (!window.authManager) {
                            console.error('AuthManager n√£o dispon√≠vel');
                            window.location.href = 'login.html';
                            return;
                        }
                    }
                    
                    // Aguardar a inicializa√ß√£o do authManager
                    if (!window.authManager.session) {
                        await window.authManager.init();
                    }
                    
                    // Verificar se est√° autenticado
                    if (!window.authManager.isUserAuthenticated()) {
                        console.log('Usu√°rio n√£o autenticado, redirecionando para login');
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    // Usar o authManager global
                    this.authManager = window.authManager;
                    
                    // Carregar informa√ß√µes do usu√°rio
                    await this.loadUserInfo();
                    
                    // Verifica se j√° h√° um m√≥dulo selecionado
                    const selectedModule = localStorage.getItem('selectedModule');
                    if (selectedModule) {
                        console.log(`M√≥dulo j√° selecionado: ${selectedModule}`);
                        this.showBackButton(selectedModule);
                    }
                    
                    // Carregar permiss√µes
                    await this.loadUserPermissions();
                    
                    // Renderizar m√≥dulos
                    this.renderModules();
                    
                    // Configurar eventos
                    this.setupEventListeners();
                    
                    // Esconder loading
                    document.getElementById('loadingOverlay').style.display = 'none';
                    
                } catch (error) {
                    console.error('Erro ao inicializar:', error);
                    this.showError('Erro ao carregar o sistema');
                }
            }
            
            /**
             * Mostra o bot√£o para voltar ao dashboard
             */
            showBackButton(moduleId) {
                const backButton = document.getElementById('back-to-module');
                if (backButton) {
                    backButton.style.display = 'block';
                    
                    // Atualiza o texto do bot√£o com o nome do m√≥dulo
                    const moduleNames = {
                        'inventory': 'Invent√°rio'
                    };
                    
                    const moduleName = moduleNames[moduleId] || 'Dashboard';
                    const button = backButton.querySelector('button');
                    if (button) {
                        button.innerHTML = `
                            <i class="fas fa-arrow-left"></i>
                            Voltar ao ${moduleName}
                        `;
                    }
                }
            }
            
            async loadUserInfo() {
                const user = this.authManager.getCurrentUser();
                if (user) {
                    document.getElementById('userEmail').textContent = user.email;
                }
            }
            
            async loadUserPermissions() {
                try {
                    const user = this.authManager.getCurrentUser();
                    if (!user) return;
                    
                    // Carregar permiss√µes do usu√°rio via API usando authenticatedFetch
                    const response = await authenticatedFetch('/api/auth/me');
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const userData = await response.json();
                    
                    console.log('üì• Received user data from API:', userData);
                    
                    // Access the nested user object if it exists, otherwise use userData directly
                    const userInfo = userData.user || userData;
                    
                    this.userRoles = userInfo.roles || [];
                    this.userPermissions = userInfo.permissions || [];
                    
                    console.log('Permiss√µes carregadas:', this.userPermissions);
                    console.log('Roles carregadas:', this.userRoles);
                    
                } catch (error) {
                    console.error('Erro ao carregar permiss√µes:', error);
                }
            }
            
            hasModuleAccess(module) {
                // Admin tem acesso total
                if (this.userRoles.includes('admin')) {
                    return true;
                }
                
                // Verificar se tem pelo menos uma permiss√£o necess√°ria
                return module.requiredPermissions.some(requiredPerm => {
                    return this.userPermissions.some(userPerm => {
                        return userPerm.name === requiredPerm || 
                               userPerm.module_name === module.id ||
                               (userPerm.module_name === 'inventory' && module.id === 'inventory') ||
                               (userPerm.module_name === 'laboratory' && module.id === 'laboratory');
                    });
                });
            }
            
            renderModules() {
                const container = document.getElementById('modulesContainer');
                const noModulesMessage = document.getElementById('noModulesMessage');
                
                const accessibleModules = this.availableModules.filter(module => 
                    this.hasModuleAccess(module)
                );
                
                if (accessibleModules.length === 0) {
                    container.style.display = 'none';
                    noModulesMessage.classList.remove('hidden');
                    return;
                }
                
                container.innerHTML = '';
                
                accessibleModules.forEach((module, index) => {
                    const moduleCard = this.createModuleCard(module, index);
                    container.appendChild(moduleCard);
                });
            }
            
            createModuleCard(module, index) {
                const card = document.createElement('div');
                card.className = `module-card glass-effect rounded-3xl p-8 text-center cursor-pointer animate-slide-up`;
                card.style.animationDelay = `${index * 0.1}s`;
                
                card.innerHTML = `
                    <div class="mb-6">
                        <div class="w-20 h-20 mx-auto mb-4 bg-gradient-to-r ${module.color} rounded-full flex items-center justify-center shadow-lg">
                            <i class="${module.icon} text-3xl text-white"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-white mb-2">
                            ${module.emoji} ${module.name}
                        </h3>
                        <p class="text-white/80 text-sm">
                            ${module.description}
                        </p>
                    </div>
                    
                    <button class="w-full bg-gradient-to-r ${module.color} hover:bg-gradient-to-r hover:${module.hoverColor} text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg">
                        <i class="fas fa-arrow-right mr-2"></i>
                        Acessar ${module.name}
                    </button>
                `;
                
                card.addEventListener('click', () => {
                    this.selectModule(module);
                });
                
                return card;
            }
            
            selectModule(module) {
                // Salvar m√≥dulo selecionado no localStorage
                localStorage.setItem('selectedModule', module.id);
                
                // Redirecionar para o dashboard
                window.location.href = 'index.html';
            }
            
            setupEventListeners() {
                // Logout
                document.getElementById('logoutBtn').addEventListener('click', async () => {
                    try {
                        await this.authManager.signOut();
                        window.location.href = 'login.html';
                    } catch (error) {
                        console.error('Erro ao fazer logout:', error);
                    }
                });
            }
            
            showError(message) {
                const overlay = document.getElementById('loadingOverlay');
                overlay.innerHTML = `
                    <div class="glass-effect rounded-2xl p-8 text-center max-w-md">
                        <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-4"></i>
                        <h3 class="text-white text-xl font-bold mb-2">Erro</h3>
                        <p class="text-white/80 mb-4">${message}</p>
                        <button onclick="location.reload()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                            Tentar Novamente
                        </button>
                    </div>
                `;
            }
        }
        
        // Inicializar quando o DOM estiver pronto
        document.addEventListener('DOMContentLoaded', async () => {
            // Aguardar o authManager ser inicializado
            if (!window.authManager) {
                window.authManager = new AuthManager();
                await window.authManager.init();
            }
            
            new ModuleSelector();
        });
    </script>
    
    <!-- Scripts necess√°rios -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script src="modules.js"></script>
</body>
</html>